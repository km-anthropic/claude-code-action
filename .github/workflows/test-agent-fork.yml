name: Test Agent Mode in Fork

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number in fork to review"
        required: true
        type: string

jobs:
  test-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: km-anthropic/claude-code-action
          ref: v1-dev
          
      - name: Review PR with Agent Mode
        uses: ./
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Please review PR #${{ inputs.pr_number }} in the km-anthropic/claude-code-action repository.
            
            Focus on:
            - Code quality and best practices
            - Potential bugs or issues
            - Suggestions for improvements
            
            Use the GitHub MCP tools to create a proper PR review:
            1. Use mcp__github__get_pull_request to fetch PR details
            2. Use mcp__github__create_pending_pull_request_review to start a review
            3. Add review comments as needed
            4. Use mcp__github__submit_pull_request_review with event_type: COMMENT (not APPROVE)
          claude_args: "--allowedTools mcp__github__*,Read,Grep,Glob"